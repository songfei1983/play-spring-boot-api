<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®æ¶æ„å›¾æŸ¥çœ‹å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            overflow-x: hidden;
        }
        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 300;
        }
        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 1em;
        }
        .nav {
            background: #2c3e50;
            padding: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .nav button {
            background: none;
            border: none;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .nav button:hover {
            background-color: #34495e;
        }
        .nav button.active {
            background-color: #3498db;
        }
        .content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            height: calc(100vh - 200px);
        }
        .diagram-container {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            height: calc(100vh - 250px);
            display: flex;
            flex-direction: column;
        }
        .diagram-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
            flex-shrink: 0;
        }
        .mermaid {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0;
        }
        .mermaid svg {
            max-width: 100% !important;
            max-height: 100% !important;
            width: auto !important;
            height: auto !important;
        }
        .tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .tech-category {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
        }
        .tech-category h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .tech-list {
            list-style: none;
            padding: 0;
        }
        .tech-list li {
            padding: 5px 0;
            border-bottom: 1px solid #bdc3c7;
        }
        .tech-list li:last-child {
            border-bottom: none;
        }
        .hidden {
            display: none;
        }
        .instructions {
            background: #e8f6f3;
            border-left: 4px solid #1abc9c;
            padding: 10px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
            flex-shrink: 0;
        }
        .instructions h3 {
            color: #16a085;
            margin-top: 0;
            font-size: 1.1em;
        }
        .instructions ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 2px 0;
            font-size: 0.9em;
        }
        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
            }
            .nav button {
                text-align: center;
            }
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ Spring Boot OpenRTB API</h1>
            <p>é¡¹ç›®æ¶æ„å›¾å¯è§†åŒ–æŸ¥çœ‹å™¨</p>
        </div>
        
        <div class="nav">
            <button onclick="showDiagram('overall')" class="active" id="btn-overall">æ•´ä½“æ¶æ„</button>
            <button onclick="showDiagram('sequence')" id="btn-sequence">ç«ä»·æµç¨‹</button>
            <button onclick="showDiagram('dataflow')" id="btn-dataflow">æ•°æ®æµ</button>
            <button onclick="showDiagram('deployment')" id="btn-deployment">éƒ¨ç½²æ¶æ„</button>
            <button onclick="showDiagram('techstack')" id="btn-techstack">æŠ€æœ¯æ ˆ</button>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
                <ul>
                    <li>ç‚¹å‡»ä¸Šæ–¹å¯¼èˆªæŒ‰é’®åˆ‡æ¢ä¸åŒçš„æ¶æ„è§†å›¾</li>
                    <li>å›¾è¡¨æ”¯æŒç¼©æ”¾å’Œæ‹–æ‹½æ“ä½œ</li>
                    <li>å»ºè®®ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Safariã€Edgeï¼‰è·å¾—æœ€ä½³ä½“éªŒ</li>
                    <li>å¦‚æœå›¾è¡¨æ˜¾ç¤ºå¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</li>
                </ul>
            </div>
            
            <!-- æ•´ä½“æ¶æ„å›¾ -->
            <div id="overall-diagram" class="diagram-container">
                <div class="diagram-title">ğŸ›ï¸ æ•´ä½“ç³»ç»Ÿæ¶æ„</div>
                <div class="mermaid">
graph TB
    %% å¤–éƒ¨ç³»ç»Ÿ
    Client["å®¢æˆ·ç«¯/å‰ç«¯åº”ç”¨"]
    ADX["Ad Exchange/SSP"]
    DSP["DSPå¹³å°"]
    
    %% APIç½‘å…³å±‚
    subgraph "API Gateway Layer"
        NGINX["Nginx (Port 80)"]
        API["Spring Boot API (Port 8080)"]
    end
    
    %% åº”ç”¨å±‚
    subgraph "Application Layer"
        direction TB
        
        %% ç”¨æˆ·ç®¡ç†æ¨¡å—
        subgraph "Users Module"
            UC["UserController"]
            UPC["UserProfileController"]
            ATC["ActivityTrackController"]
            PHC["PurchaseHistoryController"]
        end
        
        %% å¹¿å‘Šç«ä»·æ¨¡å—
        subgraph "Ads Module"
            BC["BidController"]
        end
    end
    
    %% æœåŠ¡å±‚
    subgraph "Service Layer"
        direction TB
        
        %% ç”¨æˆ·æœåŠ¡
        subgraph "User Services"
            US["UserService"]
            UPS["UserProfileService"]
            ATS["ActivityTrackService"]
            PHS["PurchaseHistoryService"]
        end
        
        %% å¹¿å‘ŠæœåŠ¡
        subgraph "Ad Services"
            BS["BidServer"]
            BA["BiddingAlgorithm"]
            ASF["AdSlotFilterService"]
            FDS["FraudDetectionService"]
            BUS["BudgetService"]
            CS["CampaignService"]
        end
    end
    
    %% åŸºç¡€è®¾æ–½å±‚
    subgraph "Infrastructure Layer"
        direction TB
        
        %% ç”¨æˆ·æ•°æ®è®¿é—®
        subgraph "User Repositories"
            UR["UserRepository"]
            UPR["UserProfileRepository"]
            ATR["ActivityTrackRepository"]
            PHR["PurchaseHistoryRepository"]
        end
        
        %% å¹¿å‘Šæ•°æ®è®¿é—®
        subgraph "Ads Repositories"
            BRR["BidRequestRepository"]
            BRRE["BidResponseRepository"]
            CR["CampaignRepository"]
            IR["InventoryRepository"]
            BSR["BidStatisticsRepository"]
        end
        
        %% æ•°æ®æœåŠ¡
        subgraph "Data Services"
            ORDS["OpenRTBDataService"]
        end
    end
    
    %% æ•°æ®åº“å±‚
    subgraph "Database Layer"
        MONGO[("MongoDB\n(OpenRTB Data)")]
        H2[("H2 Database\n(User Data)")]
    end
    
    %% è¿æ¥å…³ç³»
    Client --> NGINX
    ADX --> API
    DSP --> API
    NGINX --> API
    
    API --> UC
    API --> UPC
    API --> ATC
    API --> PHC
    API --> BC
    
    UC --> US
    UPC --> UPS
    ATC --> ATS
    PHC --> PHS
    BC --> BS
    
    US --> UR
    UPS --> UPR
    ATS --> ATR
    PHS --> PHR
    
    BS --> BA
    BS --> ASF
    BS --> FDS
    BS --> BUS
    
    BA --> CS
    BUS --> CS
    ASF --> CR
    FDS --> BSR
    
    CS --> ORDS
    ORDS --> BRR
    ORDS --> BRRE
    ORDS --> CR
    ORDS --> IR
    ORDS --> BSR
    
    UR --> H2
    UPR --> H2
    ATR --> H2
    PHR --> H2
    
    BRR --> MONGO
    BRRE --> MONGO
    CR --> MONGO
    IR --> MONGO
    BSR --> MONGO
    
    classDef controller fill:#e1f5fe
    classDef service fill:#f3e5f5
    classDef repository fill:#fff3e0
    classDef database fill:#ffebee
    classDef external fill:#f5f5f5
    
    class UC,UPC,ATC,PHC,BC controller
    class US,UPS,ATS,PHS,BS,BA,ASF,FDS,BUS,CS,ORDS service
    class UR,UPR,ATR,PHR,BRR,BRRE,CR,IR,BSR repository
    class MONGO,H2 database
    class Client,ADX,DSP,NGINX external
                </div>
            </div>
            
            <!-- ç«ä»·æµç¨‹å›¾ -->
            <div id="sequence-diagram" class="diagram-container hidden">
                <div class="diagram-title">ğŸ”„ OpenRTBç«ä»·æµç¨‹</div>
                <div class="mermaid">
sequenceDiagram
    participant ADX as Ad Exchange
    participant BC as BidController
    participant BS as BidServer
    participant ASF as AdSlotFilterService
    participant FDS as FraudDetectionService
    participant BA as BiddingAlgorithm
    participant BUS as BudgetService
    participant CS as CampaignService
    participant ORDS as OpenRTBDataService
    participant MONGO as MongoDB
    
    ADX->>BC: Bid Request (OpenRTB)
    BC->>BS: Process Bid Request
    
    BS->>ASF: Filter Ad Slots
    ASF->>MONGO: Query Campaign Data
    MONGO-->>ASF: Campaign Info
    ASF-->>BS: Filtered Candidates
    
    BS->>FDS: Fraud Detection
    FDS->>MONGO: Check Fraud Patterns
    MONGO-->>FDS: Fraud Analysis
    FDS-->>BS: Fraud Score
    
    BS->>BA: Calculate Bid Price
    BA->>CS: Get Campaign Data
    CS->>ORDS: Query Campaign Info
    ORDS->>MONGO: Get Campaign Data
    MONGO-->>ORDS: Campaign Info
    ORDS-->>CS: Campaign Data
    CS-->>BA: Campaign Info
    BA-->>BS: Bid Price
    
    BS->>BUS: Check Budget
    BUS->>CS: Get Campaign Budget
    CS->>ORDS: Query Budget Info
    ORDS->>MONGO: Get Budget Data
    MONGO-->>ORDS: Budget Info
    ORDS-->>CS: Budget Data
    CS-->>BUS: Budget Info
    BUS-->>BS: Budget Approval
    
    BS->>MONGO: Store Bid Response
    BS-->>BC: Bid Response
    BC-->>ADX: Bid Response (OpenRTB)
                </div>
            </div>
            
            <!-- æ•°æ®æµå›¾ -->
            <div id="dataflow-diagram" class="diagram-container hidden">
                <div class="diagram-title">ğŸ“Š æ•°æ®æµæ¶æ„</div>
                <div class="mermaid">
flowchart LR
    %% æ•°æ®è¾“å…¥
    subgraph "Data Input"
        BR["Bid Requests"]
        UA["User Activities"]
        PH["Purchase History"]
    end
    
    %% æ•°æ®å¤„ç†
    subgraph "Data Processing"
        RT["Real-time Processing"]
        BATCH["Batch Processing"]
        ML["Machine Learning"]
    end
    
    %% æ•°æ®å­˜å‚¨
    subgraph "Data Storage"
        MONGO_RT[("MongoDB\n(Real-time Data)")]
        H2_USER[("H2\n(User Data)")]
        CACHE["Redis Cache"]
    end
    
    %% æ•°æ®è¾“å‡º
    subgraph "Data Output"
        API_RESP["API Responses"]
        ANALYTICS["Analytics"]
        REPORTS["Reports"]
    end
    
    BR --> RT
    UA --> BATCH
    PH --> BATCH
    
    RT --> MONGO_RT
    BATCH --> H2_USER
    
    MONGO_RT --> CACHE
    H2_USER --> CACHE
    
    CACHE --> API_RESP
    MONGO_RT --> ANALYTICS
    H2_USER --> REPORTS
    
    ML --> CACHE
    MONGO_RT --> ML
    H2_USER --> ML
                </div>
            </div>
            
            <!-- éƒ¨ç½²æ¶æ„å›¾ -->
            <div id="deployment-diagram" class="diagram-container hidden">
                <div class="diagram-title">ğŸš€ éƒ¨ç½²æ¶æ„</div>
                <div class="mermaid">
graph TB
    %% è´Ÿè½½å‡è¡¡
    LB["Load Balancer"]
    
    %% åº”ç”¨å®ä¾‹
    subgraph "Application Tier"
        APP1["Spring Boot App 1\n(Port 8080)"]
        APP2["Spring Boot App 2\n(Port 8081)"]
        APP3["Spring Boot App 3\n(Port 8082)"]
    end
    
    %% å‰ç«¯
    subgraph "Frontend Tier"
        NGINX["Nginx\n(Port 80)"]
        REACT["React App"]
    end
    
    %% æ•°æ®åº“é›†ç¾¤
    subgraph "Database Tier"
        MONGO_PRIMARY[("MongoDB Primary")]
        MONGO_SECONDARY[("MongoDB Secondary")]
        H2_DB[("H2 Database")]
    end
    
    %% ç¼“å­˜å±‚
    subgraph "Cache Tier"
        REDIS["Redis Cluster"]
    end
    
    %% ç›‘æ§
    subgraph "Monitoring"
        PROMETHEUS["Prometheus"]
        GRAFANA["Grafana"]
        LOGS["Log Aggregation"]
    end
    
    LB --> APP1
    LB --> APP2
    LB --> APP3
    
    NGINX --> REACT
    NGINX --> LB
    
    APP1 --> MONGO_PRIMARY
    APP2 --> MONGO_PRIMARY
    APP3 --> MONGO_PRIMARY
    
    MONGO_PRIMARY --> MONGO_SECONDARY
    
    APP1 --> H2_DB
    APP2 --> H2_DB
    APP3 --> H2_DB
    
    APP1 --> REDIS
    APP2 --> REDIS
    APP3 --> REDIS
    
    APP1 --> PROMETHEUS
    APP2 --> PROMETHEUS
    APP3 --> PROMETHEUS
    
    PROMETHEUS --> GRAFANA
    APP1 --> LOGS
    APP2 --> LOGS
    APP3 --> LOGS
                </div>
            </div>
            
            <!-- æŠ€æœ¯æ ˆ -->
            <div id="techstack-diagram" class="diagram-container hidden">
                <div class="diagram-title">ğŸ› ï¸ æŠ€æœ¯æ ˆæ¦‚è§ˆ</div>
                <div class="tech-stack">
                    <div class="tech-category">
                        <h3>ğŸ”§ åç«¯æŠ€æœ¯æ ˆ</h3>
                        <ul class="tech-list">
                            <li><strong>æ¡†æ¶:</strong> Spring Boot 3.x</li>
                            <li><strong>æ•°æ®åº“:</strong> MongoDB, H2</li>
                            <li><strong>ç¼“å­˜:</strong> Redis</li>
                            <li><strong>æ„å»ºå·¥å…·:</strong> Maven</li>
                            <li><strong>å®¹å™¨åŒ–:</strong> Docker + Docker Compose</li>
                            <li><strong>APIæ–‡æ¡£:</strong> OpenAPI 3.0 (Swagger)</li>
                            <li><strong>æµ‹è¯•:</strong> JUnit 5, Mockito</li>
                        </ul>
                    </div>
                    
                    <div class="tech-category">
                        <h3>ğŸ¨ å‰ç«¯æŠ€æœ¯æ ˆ</h3>
                        <ul class="tech-list">
                            <li><strong>æ¡†æ¶:</strong> React 19.x</li>
                            <li><strong>æ„å»ºå·¥å…·:</strong> npm</li>
                            <li><strong>WebæœåŠ¡å™¨:</strong> Nginx</li>
                            <li><strong>æµ‹è¯•:</strong> Playwright</li>
                            <li><strong>UIç»„ä»¶:</strong> è‡ªå®šä¹‰ç»„ä»¶</li>
                            <li><strong>çŠ¶æ€ç®¡ç†:</strong> React Hooks</li>
                        </ul>
                    </div>
                    
                    <div class="tech-category">
                        <h3>ğŸ“Š ç›‘æ§ä¸è¿ç»´</h3>
                        <ul class="tech-list">
                            <li><strong>ç›‘æ§:</strong> Prometheus + Grafana</li>
                            <li><strong>æ—¥å¿—:</strong> SLF4J + Logback</li>
                            <li><strong>å¥åº·æ£€æŸ¥:</strong> Spring Boot Actuator</li>
                            <li><strong>å®¹å™¨ç¼–æ’:</strong> Docker Compose</li>
                            <li><strong>è´Ÿè½½å‡è¡¡:</strong> Nginx</li>
                        </ul>
                    </div>
                    
                    <div class="tech-category">
                        <h3>ğŸ”’ å®‰å…¨ä¸è´¨é‡</h3>
                        <ul class="tech-list">
                            <li><strong>CORSé…ç½®:</strong> Spring Security</li>
                            <li><strong>æ•°æ®éªŒè¯:</strong> Bean Validation</li>
                            <li><strong>å¼‚å¸¸å¤„ç†:</strong> å…¨å±€å¼‚å¸¸å¤„ç†å™¨</li>
                            <li><strong>ä»£ç è´¨é‡:</strong> Lombok, åˆ†å±‚æ¶æ„</li>
                            <li><strong>æ–‡æ¡£:</strong> è‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // åˆå§‹åŒ–Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            }
        });
        
        // æ˜¾ç¤ºæŒ‡å®šçš„å›¾è¡¨
        function showDiagram(diagramType) {
            // éšè—æ‰€æœ‰å›¾è¡¨
            const diagrams = document.querySelectorAll('.diagram-container');
            diagrams.forEach(diagram => {
                diagram.classList.add('hidden');
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
            const buttons = document.querySelectorAll('.nav button');
            buttons.forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„å›¾è¡¨
            const targetDiagram = document.getElementById(diagramType + '-diagram');
            if (targetDiagram) {
                targetDiagram.classList.remove('hidden');
            }
            
            // æ¿€æ´»é€‰ä¸­çš„æŒ‰é’®
            const targetButton = document.getElementById('btn-' + diagramType);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåé‡æ–°æ¸²æŸ“Mermaidå›¾è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                mermaid.init();
            }, 100);
        });
    </script>
</body>
</html>