<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目架构图查看器</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            overflow-x: hidden;
        }
        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 300;
        }
        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 1em;
        }
        .nav {
            background: #2c3e50;
            padding: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .nav button {
            background: none;
            border: none;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .nav button:hover {
            background-color: #34495e;
        }
        .nav button.active {
            background-color: #3498db;
        }
        .content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            height: calc(100vh - 200px);
        }
        .diagram-container {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            height: calc(100vh - 250px);
            display: flex;
            flex-direction: column;
        }
        .diagram-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
            flex-shrink: 0;
        }
        .mermaid {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0;
        }
        .mermaid svg {
            max-width: 100% !important;
            max-height: 100% !important;
            width: auto !important;
            height: auto !important;
        }
        .tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .tech-category {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
        }
        .tech-category h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .tech-list {
            list-style: none;
            padding: 0;
        }
        .tech-list li {
            padding: 5px 0;
            border-bottom: 1px solid #bdc3c7;
        }
        .tech-list li:last-child {
            border-bottom: none;
        }
        .hidden {
            display: none;
        }
        .instructions {
            background: #e8f6f3;
            border-left: 4px solid #1abc9c;
            padding: 10px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
            flex-shrink: 0;
        }
        .instructions h3 {
            color: #16a085;
            margin-top: 0;
            font-size: 1.1em;
        }
        .instructions ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 2px 0;
            font-size: 0.9em;
        }
        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
            }
            .nav button {
                text-align: center;
            }
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏗️ Spring Boot OpenRTB API</h1>
            <p>项目架构图可视化查看器</p>
        </div>
        
        <div class="nav">
            <button onclick="showDiagram('overall')" class="active" id="btn-overall">整体架构</button>
            <button onclick="showDiagram('sequence')" id="btn-sequence">竞价流程</button>
            <button onclick="showDiagram('dataflow')" id="btn-dataflow">数据流</button>
            <button onclick="showDiagram('deployment')" id="btn-deployment">部署架构</button>
            <button onclick="showDiagram('techstack')" id="btn-techstack">技术栈</button>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>📋 使用说明</h3>
                <ul>
                    <li>点击上方导航按钮切换不同的架构视图</li>
                    <li>图表支持缩放和拖拽操作</li>
                    <li>建议使用现代浏览器（Chrome、Firefox、Safari、Edge）获得最佳体验</li>
                    <li>如果图表显示异常，请刷新页面重试</li>
                </ul>
            </div>
            
            <!-- 整体架构图 -->
            <div id="overall-diagram" class="diagram-container">
                <div class="diagram-title">🏛️ 整体系统架构</div>
                <div class="mermaid">
graph TB
    %% 外部系统
    Client["客户端/前端应用"]
    ADX["Ad Exchange/SSP"]
    DSP["DSP平台"]
    
    %% API网关层
    subgraph "API Gateway Layer"
        NGINX["Nginx (Port 80)"]
        API["Spring Boot API (Port 8080)"]
    end
    
    %% 应用层
    subgraph "Application Layer"
        direction TB
        
        %% 用户管理模块
        subgraph "Users Module"
            UC["UserController"]
            UPC["UserProfileController"]
            ATC["ActivityTrackController"]
            PHC["PurchaseHistoryController"]
        end
        
        %% 广告竞价模块
        subgraph "Ads Module"
            BC["BidController"]
        end
    end
    
    %% 服务层
    subgraph "Service Layer"
        direction TB
        
        %% 用户服务
        subgraph "User Services"
            US["UserService"]
            UPS["UserProfileService"]
            ATS["ActivityTrackService"]
            PHS["PurchaseHistoryService"]
        end
        
        %% 广告服务
        subgraph "Ad Services"
            BS["BidServer"]
            BA["BiddingAlgorithm"]
            ASF["AdSlotFilterService"]
            FDS["FraudDetectionService"]
            BUS["BudgetService"]
            CS["CampaignService"]
        end
    end
    
    %% 基础设施层
    subgraph "Infrastructure Layer"
        direction TB
        
        %% 用户数据访问
        subgraph "User Repositories"
            UR["UserRepository"]
            UPR["UserProfileRepository"]
            ATR["ActivityTrackRepository"]
            PHR["PurchaseHistoryRepository"]
        end
        
        %% 广告数据访问
        subgraph "Ads Repositories"
            BRR["BidRequestRepository"]
            BRRE["BidResponseRepository"]
            CR["CampaignRepository"]
            IR["InventoryRepository"]
            BSR["BidStatisticsRepository"]
        end
        
        %% 数据服务
        subgraph "Data Services"
            ORDS["OpenRTBDataService"]
        end
    end
    
    %% 数据库层
    subgraph "Database Layer"
        MONGO[("MongoDB\n(OpenRTB Data)")]
        H2[("H2 Database\n(User Data)")]
    end
    
    %% 连接关系
    Client --> NGINX
    ADX --> API
    DSP --> API
    NGINX --> API
    
    API --> UC
    API --> UPC
    API --> ATC
    API --> PHC
    API --> BC
    
    UC --> US
    UPC --> UPS
    ATC --> ATS
    PHC --> PHS
    BC --> BS
    
    US --> UR
    UPS --> UPR
    ATS --> ATR
    PHS --> PHR
    
    BS --> BA
    BS --> ASF
    BS --> FDS
    BS --> BUS
    
    BA --> CS
    BUS --> CS
    ASF --> CR
    FDS --> BSR
    
    CS --> ORDS
    ORDS --> BRR
    ORDS --> BRRE
    ORDS --> CR
    ORDS --> IR
    ORDS --> BSR
    
    UR --> H2
    UPR --> H2
    ATR --> H2
    PHR --> H2
    
    BRR --> MONGO
    BRRE --> MONGO
    CR --> MONGO
    IR --> MONGO
    BSR --> MONGO
    
    classDef controller fill:#e1f5fe
    classDef service fill:#f3e5f5
    classDef repository fill:#fff3e0
    classDef database fill:#ffebee
    classDef external fill:#f5f5f5
    
    class UC,UPC,ATC,PHC,BC controller
    class US,UPS,ATS,PHS,BS,BA,ASF,FDS,BUS,CS,ORDS service
    class UR,UPR,ATR,PHR,BRR,BRRE,CR,IR,BSR repository
    class MONGO,H2 database
    class Client,ADX,DSP,NGINX external
                </div>
            </div>
            
            <!-- 竞价流程图 -->
            <div id="sequence-diagram" class="diagram-container hidden">
                <div class="diagram-title">🔄 OpenRTB竞价流程</div>
                <div class="mermaid">
sequenceDiagram
    participant ADX as Ad Exchange
    participant BC as BidController
    participant BS as BidServer
    participant ASF as AdSlotFilterService
    participant FDS as FraudDetectionService
    participant BA as BiddingAlgorithm
    participant BUS as BudgetService
    participant CS as CampaignService
    participant ORDS as OpenRTBDataService
    participant MONGO as MongoDB
    
    ADX->>BC: Bid Request (OpenRTB)
    BC->>BS: Process Bid Request
    
    BS->>ASF: Filter Ad Slots
    ASF->>MONGO: Query Campaign Data
    MONGO-->>ASF: Campaign Info
    ASF-->>BS: Filtered Candidates
    
    BS->>FDS: Fraud Detection
    FDS->>MONGO: Check Fraud Patterns
    MONGO-->>FDS: Fraud Analysis
    FDS-->>BS: Fraud Score
    
    BS->>BA: Calculate Bid Price
    BA->>CS: Get Campaign Data
    CS->>ORDS: Query Campaign Info
    ORDS->>MONGO: Get Campaign Data
    MONGO-->>ORDS: Campaign Info
    ORDS-->>CS: Campaign Data
    CS-->>BA: Campaign Info
    BA-->>BS: Bid Price
    
    BS->>BUS: Check Budget
    BUS->>CS: Get Campaign Budget
    CS->>ORDS: Query Budget Info
    ORDS->>MONGO: Get Budget Data
    MONGO-->>ORDS: Budget Info
    ORDS-->>CS: Budget Data
    CS-->>BUS: Budget Info
    BUS-->>BS: Budget Approval
    
    BS->>MONGO: Store Bid Response
    BS-->>BC: Bid Response
    BC-->>ADX: Bid Response (OpenRTB)
                </div>
            </div>
            
            <!-- 数据流图 -->
            <div id="dataflow-diagram" class="diagram-container hidden">
                <div class="diagram-title">📊 数据流架构</div>
                <div class="mermaid">
flowchart LR
    %% 数据输入
    subgraph "Data Input"
        BR["Bid Requests"]
        UA["User Activities"]
        PH["Purchase History"]
    end
    
    %% 数据处理
    subgraph "Data Processing"
        RT["Real-time Processing"]
        BATCH["Batch Processing"]
        ML["Machine Learning"]
    end
    
    %% 数据存储
    subgraph "Data Storage"
        MONGO_RT[("MongoDB\n(Real-time Data)")]
        H2_USER[("H2\n(User Data)")]
        CACHE["Redis Cache"]
    end
    
    %% 数据输出
    subgraph "Data Output"
        API_RESP["API Responses"]
        ANALYTICS["Analytics"]
        REPORTS["Reports"]
    end
    
    BR --> RT
    UA --> BATCH
    PH --> BATCH
    
    RT --> MONGO_RT
    BATCH --> H2_USER
    
    MONGO_RT --> CACHE
    H2_USER --> CACHE
    
    CACHE --> API_RESP
    MONGO_RT --> ANALYTICS
    H2_USER --> REPORTS
    
    ML --> CACHE
    MONGO_RT --> ML
    H2_USER --> ML
                </div>
            </div>
            
            <!-- 部署架构图 -->
            <div id="deployment-diagram" class="diagram-container hidden">
                <div class="diagram-title">🚀 部署架构</div>
                <div class="mermaid">
graph TB
    %% 负载均衡
    LB["Load Balancer"]
    
    %% 应用实例
    subgraph "Application Tier"
        APP1["Spring Boot App 1\n(Port 8080)"]
        APP2["Spring Boot App 2\n(Port 8081)"]
        APP3["Spring Boot App 3\n(Port 8082)"]
    end
    
    %% 前端
    subgraph "Frontend Tier"
        NGINX["Nginx\n(Port 80)"]
        REACT["React App"]
    end
    
    %% 数据库集群
    subgraph "Database Tier"
        MONGO_PRIMARY[("MongoDB Primary")]
        MONGO_SECONDARY[("MongoDB Secondary")]
        H2_DB[("H2 Database")]
    end
    
    %% 缓存层
    subgraph "Cache Tier"
        REDIS["Redis Cluster"]
    end
    
    %% 监控
    subgraph "Monitoring"
        PROMETHEUS["Prometheus"]
        GRAFANA["Grafana"]
        LOGS["Log Aggregation"]
    end
    
    LB --> APP1
    LB --> APP2
    LB --> APP3
    
    NGINX --> REACT
    NGINX --> LB
    
    APP1 --> MONGO_PRIMARY
    APP2 --> MONGO_PRIMARY
    APP3 --> MONGO_PRIMARY
    
    MONGO_PRIMARY --> MONGO_SECONDARY
    
    APP1 --> H2_DB
    APP2 --> H2_DB
    APP3 --> H2_DB
    
    APP1 --> REDIS
    APP2 --> REDIS
    APP3 --> REDIS
    
    APP1 --> PROMETHEUS
    APP2 --> PROMETHEUS
    APP3 --> PROMETHEUS
    
    PROMETHEUS --> GRAFANA
    APP1 --> LOGS
    APP2 --> LOGS
    APP3 --> LOGS
                </div>
            </div>
            
            <!-- 技术栈 -->
            <div id="techstack-diagram" class="diagram-container hidden">
                <div class="diagram-title">🛠️ 技术栈概览</div>
                <div class="tech-stack">
                    <div class="tech-category">
                        <h3>🔧 后端技术栈</h3>
                        <ul class="tech-list">
                            <li><strong>框架:</strong> Spring Boot 3.x</li>
                            <li><strong>数据库:</strong> MongoDB, H2</li>
                            <li><strong>缓存:</strong> Redis</li>
                            <li><strong>构建工具:</strong> Maven</li>
                            <li><strong>容器化:</strong> Docker + Docker Compose</li>
                            <li><strong>API文档:</strong> OpenAPI 3.0 (Swagger)</li>
                            <li><strong>测试:</strong> JUnit 5, Mockito</li>
                        </ul>
                    </div>
                    
                    <div class="tech-category">
                        <h3>🎨 前端技术栈</h3>
                        <ul class="tech-list">
                            <li><strong>框架:</strong> React 19.x</li>
                            <li><strong>构建工具:</strong> npm</li>
                            <li><strong>Web服务器:</strong> Nginx</li>
                            <li><strong>测试:</strong> Playwright</li>
                            <li><strong>UI组件:</strong> 自定义组件</li>
                            <li><strong>状态管理:</strong> React Hooks</li>
                        </ul>
                    </div>
                    
                    <div class="tech-category">
                        <h3>📊 监控与运维</h3>
                        <ul class="tech-list">
                            <li><strong>监控:</strong> Prometheus + Grafana</li>
                            <li><strong>日志:</strong> SLF4J + Logback</li>
                            <li><strong>健康检查:</strong> Spring Boot Actuator</li>
                            <li><strong>容器编排:</strong> Docker Compose</li>
                            <li><strong>负载均衡:</strong> Nginx</li>
                        </ul>
                    </div>
                    
                    <div class="tech-category">
                        <h3>🔒 安全与质量</h3>
                        <ul class="tech-list">
                            <li><strong>CORS配置:</strong> Spring Security</li>
                            <li><strong>数据验证:</strong> Bean Validation</li>
                            <li><strong>异常处理:</strong> 全局异常处理器</li>
                            <li><strong>代码质量:</strong> Lombok, 分层架构</li>
                            <li><strong>文档:</strong> 自动生成API文档</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 初始化Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            }
        });
        
        // 显示指定的图表
        function showDiagram(diagramType) {
            // 隐藏所有图表
            const diagrams = document.querySelectorAll('.diagram-container');
            diagrams.forEach(diagram => {
                diagram.classList.add('hidden');
            });
            
            // 移除所有按钮的active状态
            const buttons = document.querySelectorAll('.nav button');
            buttons.forEach(button => {
                button.classList.remove('active');
            });
            
            // 显示选中的图表
            const targetDiagram = document.getElementById(diagramType + '-diagram');
            if (targetDiagram) {
                targetDiagram.classList.remove('hidden');
            }
            
            // 激活选中的按钮
            const targetButton = document.getElementById('btn-' + diagramType);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }
        
        // 页面加载完成后重新渲染Mermaid图表
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                mermaid.init();
            }, 100);
        });
    </script>
</body>
</html>